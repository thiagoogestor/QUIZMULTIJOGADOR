<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Quiz Multiplayer (Firebase ‚Ä¢ Login Google + Recorde por Quiz)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
      * { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
      .pop-anim { animation: pop .35s ease-out; }
      @keyframes pop { 0%{transform:scale(.96)} 50%{transform:scale(1.03)} 100%{transform:scale(1)} }
      .shake-anim { animation: shake .3s ease-in-out; }
      @keyframes shake { 0%,100%{transform:translateX(0)} 20%{transform:translateX(-2px)} 40%{transform:translateX(2px)} 60%{transform:translateX(-2px)} 80%{transform:translateX(2px)} }
      .confetti-piece { position:absolute; top:-10px; border-radius:1px; opacity:.9; animation: confettiFall linear infinite; }
      @keyframes confettiFall { from{ transform: translateY(-10px) rotate(0deg); } to{ transform: translateY(110vh) rotate(360deg); } }
    /* Tipografia e utilidades visuais para ‚Äúcara de jogo‚Äù */
body { font-family: 'Kanit', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial; }
.gradient-title {
  background: linear-gradient(90deg, #a78bfa, #60a5fa, #22d3ee);
  -webkit-background-clip: text; background-clip: text; color: transparent;
  text-shadow: 0 6px 28px rgba(99,102,241,.35);
}
.glass {
  position: relative; background: rgba(15,23,42,.6);
  border-radius: 18px; border: 1px solid rgba(255,255,255,.08);
  box-shadow: 0 20px 50px rgba(31,41,55,.45);
}
.glass::before {
  content:""; position:absolute; inset:-1px; padding:1px; border-radius: inherit;
  background: conic-gradient(from 180deg, #8b5cf6, #22d3ee, #f0abfc, #8b5cf6);
  -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
  -webkit-mask-composite: xor; mask-composite: exclude; opacity:.35; pointer-events:none;
}
.btn-neo { background: linear-gradient(180deg,#7c3aed,#4f46e5); box-shadow: 0 8px 30px rgba(99,102,241,.45); }
.btn-neo:hover { filter: brightness(1.05); }
.btn-ghost { background: rgba(255,255,255,.1); border: 1px solid rgba(255,255,255,.18); }
.input-ghost { background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.18); }
.bg-grid {
  background-image:
    radial-gradient(1200px 600px at 20% 0%, rgba(99,102,241,.25), rgba(0,0,0,0) 60%),
    radial-gradient(1000px 500px at 100% 100%, rgba(236,72,153,.2), rgba(0,0,0,0) 55%),
    linear-gradient(rgba(255,255,255,.06) 1px, transparent 1px),
    linear-gradient(90deg, rgba(255,255,255,.06) 1px, transparent 1px);
  background-size: auto, auto, 36px 36px, 36px 36px;
  background-position: 0 0, 0 0, 0 0, 0 0;
}
@keyframes floaty { 0%{transform:translateY(0)} 50%{transform:translateY(-6px)} 100%{transform:translateY(0)} }
.floating { animation: floaty 4s ease-in-out infinite; }
.shine { position:absolute; inset:0; border-radius:inherit; overflow:hidden; pointer-events:none; }
.shine::before {
  content:""; position:absolute; inset:-40%;
  background: conic-gradient(from 0deg, transparent 0 20%, rgba(255,255,255,.15) 35%, transparent 50% 100%);
  animation: spin 6s linear infinite;
}
@keyframes spin { to { transform: rotate(1turn); } }
    </style>

    <!-- React UMD + Babel (no-build) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Firebase compat (sem bundler) -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  </head>
  <body class="min-h-screen bg-gradient-to-br from-slate-900 via-indigo-900 to-fuchsia-900">
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useRef, useEffect } = React;

      // üîß COLE SUA CONFIG DO FIREBASE AQUI
      const firebaseConfig = {
  apiKey: "AIzaSyBu2s6DU9d-hc5HTqSuyYLV6Ut0oOwRIls",
  authDomain: "quizmultijogador.firebaseapp.com",
  databaseURL: "https://quizmultijogador-default-rtdb.firebaseio.com",
  projectId: "quizmultijogador",
  storageBucket: "quizmultijogador.firebasestorage.app",
  messagingSenderId: "245519129065",
  appId: "1:245519129065:web:95727cf109edad07f29378",
  measurementId: "G-0BRETH5CW3"
};
      firebase.initializeApp(firebaseConfig);
      const db = firebase.database();
      const auth = firebase.auth();
      const googleProvider = new firebase.auth.GoogleAuthProvider();

      // üìö DATASET DEMO (2 quizes). Voc√™ pode adicionar mais quizes aqui.
      const QUIZZES = {
        "geral": {
                name: "Conhecimentos Gerais",
                questions: [
                    { question: "Qual √© a capital do Brasil?", answers: ["S√£o Paulo", "Rio de Janeiro", "Bras√≠lia", "Salvador"], correct: 2 },
                    { question: "Quem pintou a Mona Lisa?", answers: ["Van Gogh", "Picasso", "Da Vinci", "Michelangelo"], correct: 2 },
                    { question: "Qual o maior animal do mundo?", answers: ["Elefante", "Tubar√£o Baleia", "Baleia Azul", "Girafa"], correct: 2 },
                    { question: "Quem escreveu 'Dom Quixote'?", answers: ["Machado de Assis", "Miguel de Cervantes", "Shakespeare", "Fernando Pessoa"], correct: 1 },
                    { question: "Em que ano o homem pisou na Lua?", answers: ["1969", "1972", "1965", "1980"], correct: 0 },
                    { question: "Qual √© o rio mais longo do mundo?", answers: ["Rio Nilo", "Rio Amazonas", "Rio Mississipi", "Rio Yangtz√©"], correct: 1 },
                    { question: "Qual a montanha mais alta do mundo?", answers: ["Monte Everest", "K2", "Kangchenjunga", "Lhotse"], correct: 0 },
                    { question: "Qual a f√≥rmula qu√≠mica da √°gua?", answers: ["CO2", "O2", "H2O2", "H2O"], correct: 3 },
                    { question: "Qual pa√≠s tem o formato de uma bota?", answers: ["Gr√©cia", "Portugal", "It√°lia", "Espanha"], correct: 2},
                    { question: "Quem foi o inventor da l√¢mpada?", answers: ["Nikola Tesla", "Thomas Edison", "Graham Bell", "Santos Dumont"], correct: 1},
                    { question: "Qual a capital de Portugal?", answers: ["Madrid", "Porto", "Roma", "Lisboa"], correct: 3},
                    { question: "Quem descobriu o Brasil?", answers: ["Crist√≥v√£o Colombo", "Vasco da Gama", "Pedro √Ålvares Cabral", "Am√©rico Vesp√∫cio"], correct: 2},
                    { question: "Qual a moeda oficial do Jap√£o?", answers: ["Yuan", "Won", "Iene", "Rupia"], correct: 2},
                    { question: "Qual o nome do oceano que banha o Brasil?", answers: ["Pac√≠fico", "√çndico", "Atl√¢ntico", "√Årtico"], correct: 2 },
                    { question: "Qual o deserto mais quente do mundo?", answers: ["Saara", "Atacama", "Ar√°bia", "Gobi"], correct: 0},
                    { question: "Qual o plural de 'cidad√£o'?", answers: ["Cidad√£os", "Cidad√µes", "Cidades", "Cidad√£s"], correct: 0 },
                    { question: "Em que continente fica o Egito?", answers: ["√Åsia", "Europa", "√Åfrica", "Oceania"], correct: 2 },
                    { question: "Qual o coletivo de c√£es?", answers: ["Manada", "Cardume", "Alcateia", "Rebanho"], correct: 2 },
                    { question: "Qual o ponto mais alto do Brasil?", answers: ["Pico da Neblina", "Pico 31 de Mar√ßo", "Monte Roraima", "Pico da Bandeira"], correct: 0 },
                    { question: "Quantos lados tem um hept√°gono?", answers: ["5", "6", "7", "8"], correct: 2 }
                ]
            },
        "geral2": {
                name: "Conhecimentos Gerais 2",
                questions: [
                    { question: "Qual o livro mais vendido no mundo, a seguir √† B√≠blia?", answers: ["Dom Quixote", "O Senhor dos An√©is", "O Pequeno Pr√≠ncipe", "Harry Potter"], correct: 0 },
                    { question: "Qual a nacionalidade de Pablo Picasso?", answers: ["Italiana", "Francesa", "Espanhola", "Portuguesa"], correct: 2 },
                    { question: "Qual o metal mais abundante na crosta terrestre?", answers: ["Ferro", "Cobre", "Ouro", "Alum√≠nio"], correct: 3 },
                    { question: "Em que pa√≠s nasceu a pizza?", answers: ["Gr√©cia", "It√°lia", "Estados Unidos", "Fran√ßa"], correct: 1 },
                    { question: "Qual destes planetas n√£o tem an√©is?", answers: ["Saturno", "J√∫piter", "V√©nus", "Urano"], correct: 2 },
                    { question: "Quantas patas tem uma aranha?", answers: ["6", "8", "10", "12"], correct: 1 },
                    { question: "Qual a cidade conhecida como a 'Big Apple'?", answers: ["Los Angeles", "Chicago", "Miami", "Nova Iorque"], correct: 3 },
                    { question: "Quem foi a primeira mulher a ganhar um Pr√©mio Nobel?", answers: ["Marie Curie", "Rosalind Franklin", "Ada Lovelace", "Dorothy Hodgkin"], correct: 0 },
                    { question: "Qual o nome do maior osso do corpo humano?", answers: ["T√≠bia", "F√™mur", "√ömero", "Pelve"], correct: 1 },
                    { question: "Quantos dentes tem um ser humano adulto?", answers: ["28", "30", "32", "26"], correct: 2 },
                    { question: "Qual o nome do processo de convers√£o de a√ß√∫car em √°lcool?", answers: ["Fotoss√≠ntese", "Respira√ß√£o", "Digest√£o", "Fermenta√ß√£o"], correct: 3 },
                    { question: "Em que cidade se encontram as ru√≠nas de Machu Picchu?", answers: ["M√©xico", "Chile", "Bol√≠via", "Peru"], correct: 3 },
                    { question: "Qual a capital da Austr√°lia?", answers: ["Sydney", "Melbourne", "Camberra", "Brisbane"], correct: 2 },
                    { question: "Qual o animal que consegue sobreviver mais tempo sem √°gua?", answers: ["Camelo", "Rato-canguru", "Elefante", "Girafa"], correct: 1 },
                    { question: "Qual o nome do criador da personagem de BD 'Tintim'?", answers: ["Goscinny", "Uderzo", "Herg√©", "Franquin"], correct: 2 },
                    { question: "Qual o nome do deus do trov√£o na mitologia n√≥rdica?", answers: ["Odin", "Loki", "Thor", "Freyr"], correct: 2 },
                    { question: "Qual o oceano mais frio do mundo?", answers: ["Pac√≠fico", "Atl√¢ntico", "√çndico", "√Årtico"], correct: 3 },
                    { question: "Qual a cor que resulta da mistura de azul e amarelo?", answers: ["Roxo", "Laranja", "Verde", "Cinzento"], correct: 2 },
                    { question: "Qual o nome da primeira pessoa a viajar para o espa√ßo?", answers: ["Neil Armstrong", "Buzz Aldrin", "Yuri Gagarin", "John Glenn"], correct: 2 },
                    { question: "Qual o animal que tem o maior c√©rebro em propor√ß√£o ao seu corpo?", answers: ["Humano", "Golfinho", "Elefante", "Formiga"], correct: 3 }
                ]
            },
        "artes": {
                name: "Artes e Entretenimento",
                questions: [
                    { question: "Qual banda de rock √© conhecida como 'The Fab Four'?", answers: ["The Rolling Stones", "The Beatles", "Queen", "Led Zeppelin"], correct: 1 },
                    { question: "Quem escreveu a saga 'Harry Potter'?", answers: ["J. R. R. Tolkien", "J. K. Rowling", "George R. R. Martin", "C. S. Lewis"], correct: 1 },
                    { question: "Qual o nome do vocalista da banda Queen?", answers: ["Freddie Mercury", "Elton John", "David Bowie", "Mick Jagger"], correct: 0 },
                    { question: "Qual destes pintores √© famoso por cortar a pr√≥pria orelha?", answers: ["Pablo Picasso", "Claude Monet", "Salvador Dal√≠", "Vincent van Gogh"], correct: 3 },
                    { question: "Qual filme ganhou o primeiro Oscar de Melhor Anima√ß√£o?", answers: ["A Bela e a Fera", "O Rei Le√£o", "Toy Story", "Shrek"], correct: 3 },
                    { question: "Quem √© o autor da famosa pe√ßa 'Romeu e Julieta'?", answers: ["Machado de Assis", "Charles Dickens", "William Shakespeare", "Dante Alighieri"], correct: 2 },
                    { question: "Qual s√©rie de TV se passa em Westeros?", answers: ["The Witcher", "Game of Thrones", "Vikings", "The Last Kingdom"], correct: 1 },
                    { question: "Qual cantor √© conhecido como o 'Rei do Pop'?", answers: ["Elvis Presley", "James Brown", "Michael Jackson", "Prince"], correct: 2 },
                    { question: "De qual pa√≠s o tango √© uma dan√ßa tradicional?", answers: ["Espanha", "Brasil", "M√©xico", "Argentina"], correct: 3 },
                    { question: "Qual o nome do bruxo que √© o principal vil√£o em Harry Potter?", answers: ["Dumbledore", "Snape", "Voldemort", "Sirius Black"], correct: 2 },
                    { question: "Quem dirigiu 'Pulp Fiction'?", answers: ["Steven Spielberg", "Martin Scorsese", "Quentin Tarantino", "James Cameron"], correct: 2},
                    { question: "Qual destes n√£o √© um membro dos Vingadores originais do cinema?", answers: ["Capit√£o Am√©rica", "Homem-Formiga", "Vi√∫va Negra", "Hulk"], correct: 1},
                    { question: "Quem canta a m√∫sica 'Like a Virgin'?", answers: ["Whitney Houston", "Cyndi Lauper", "Mariah Carey", "Madonna"], correct: 3},
                    { question: "Qual o nome do boneco de madeira que queria ser um menino de verdade?", answers: ["Gepeto", "Grilo Falante", "Pin√≥quio", "Figaro"], correct: 2},
                    { question: "Em que cidade se passa a s√©rie 'La Casa de Papel'?", answers: ["Barcelona", "Madrid", "Lisboa", "Rio de Janeiro"], correct: 1},
                    { question: "Qual o nome do le√£o protagonista de 'O Rei Le√£o'?", answers: ["Mufasa", "Scar", "Simba", "Tim√£o"], correct: 2},
                    { question: "Que artista √© conhecido pela obra 'O Grito'?", answers: ["Edvard Munch", "Salvador Dal√≠", "Frida Kahlo", "Claude Monet"], correct: 0},
                    { question: "Qual o nome do carro de 'Regresso ao Futuro'?", answers: ["Ford Mustang", "Ferrari 250 GTO", "Pontiac Trans Am", "DeLorean"], correct: 3},
                    { question: "Qual o nome da personagem principal da saga 'Jogos da Fome'?", answers: ["Primrose Everdeen", "Katniss Everdeen", "Gale Hawthorne", "Peeta Mellark"], correct: 1},
                    { question: "Quem comp√¥s 'As Quatro Esta√ß√µes'?", answers: ["Bach", "Mozart", "Beethoven", "Vivaldi"], correct: 3}
                ]
            },
        ciencia: {
          name: "Ci√™ncia e Tecnologia",
          questions: [
            { q: "Qual planeta √© conhecido como 'Planeta Vermelho'?", a: ["V√™nus", "Marte", "J√∫piter", "Saturno"], c: 1 },
            { q: "Quem desenvolveu a teoria da relatividade?", a: ["Newton", "Galileu", "Einstein", "Tesla"], c: 2 },
          ],
        },
      };

      // ‚úÖ Normaliza quest√µes para { q, a, c } e tolera { question, answers, correct }
      function normalizeQuizData(baseQuiz) {
        if (!baseQuiz) return null;
        const qs = (baseQuiz.questions || []).map((item) => {
          if (typeof item?.q !== "undefined" && Array.isArray(item.a) && typeof item?.c !== "undefined") {
            return item;
          }
          return { q: item.question, a: item.answers, c: item.correct };
        });
        return { name: baseQuiz.name, questions: qs };
      }

      function Card({ children, className = "" }) {
        return <div className={`bg-white/10 backdrop-blur-xl border border-white/10 text-white rounded-xl shadow-xl p-6 ${className}`}>{children}</div>;
      }
      function Button({ children, variant = "primary", className = "", ...props }) {
        const base = "inline-flex items-center justify-center w-full font-semibold px-4 py-3 rounded-lg transition";
        const styles = variant === "primary" ? "bg-indigo-600 text-white hover:bg-indigo-700"
          : variant === "secondary" ? "bg-indigo-100 text-indigo-700 hover:bg-indigo-200 text-slate-900"
          : "bg-gray-100 text-gray-800 hover:bg-gray-200";
        return <button className={`${base} ${styles} ${className}`} {...props}>{children}</button>;
      }
      function Input({ className = "", ...props }) {
        return <input className={`block w-full px-4 py-3 rounded-lg bg-white/10 text-white placeholder:text-white/50 border border-white/20 focus:outline-none focus:ring-4 focus:ring-indigo-300 ${className}`} {...props} />;
      }
      function Confetti({ count = 80 }) {
        return (
          <div className="pointer-events-none fixed inset-0 overflow-hidden" aria-hidden>
            {Array.from({ length: count }).map((_, i) => {
              const left = Math.random() * 100;
              const size = 6 + Math.random() * 8;
              const delay = Math.random() * 2;
              const duration = 4 + Math.random() * 3;
              const hue = Math.floor(Math.random() * 360);
              const style = { left: `${left}%`, width: `${size}px`, height: `${size}px`, background: `hsl(${hue} 80% 60%)`, animationDelay: `${delay}s`, animationDuration: `${duration}s` };
              return <span key={i} className="confetti-piece" style={style} />;
            })}
          </div>
        );
      }
      function BackdropFX() {
  return (
    <div className="pointer-events-none fixed inset-0 -z-10 bg-gradient-to-br from-slate-900 via-indigo-950 to-fuchsia-900 bg-grid">
      {/* manchas de luz */}
      <div className="absolute -top-12 -left-12 w-72 h-72 rounded-full blur-3xl opacity-20"
           style={{background: 'radial-gradient(circle at 30% 30%, #8b5cf6, transparent 60%)'}} />
      <div className="absolute bottom-0 right-0 w-96 h-96 rounded-full blur-3xl opacity-20 floating"
           style={{background: 'radial-gradient(circle at 70% 70%, #22d3ee, transparent 60%)'}} />
    </div>
  );
}

      function App() {
        
        const [screen, setScreen] = useState("lobby");
        const [name, setName] = useState("");
        const [isHost, setIsHost] = useState(true);
        const [gameCode, setGameCode] = useState(() => Math.random().toString(36).slice(2,7).toUpperCase());
        const [selectedQuizKey, setSelectedQuizKey] = useState(null);
        const [copied, setCopied] = useState(false);

        const [user, setUser] = useState(null);
        const [playerIdFallback] = useState(() => Math.random().toString(36).slice(2,10)); // id tempor√°rio p/ quem joga sem login
        const [room, setRoom] = useState("");
        const [players, setPlayers] = useState([]);
        const [qid, setQid] = useState(0);
        const [picked, setPicked] = useState(null);
        const [started, setStarted] = useState(false);
        const [joinCode, setJoinCode] = useState("");

        const [userBest, setUserBest] = useState({}); // üèÜ recordes por quiz do usu√°rio
        const savedOnceRef = useRef(false);

        // usa UID do Google se logado; sen√£o, id tempor√°rio
        const pid = user?.uid || playerIdFallback;

        // Login ‚Üí seta user, preenche nome, e se j√° estiver numa sala, faz bind fallback‚Üíuid
        useEffect(() => {
          const unsub = auth.onAuthStateChanged(async (u) => {
            setUser(u);
            if (u && !name) setName(u.displayName || (u.email ? u.email.split("@")[0] : "Jogador"));
            if (u && room) { await bindPlayerToUidIfNeeded(u); }
          });
          return unsub;
        }, [name, room]);

        // Carrega recordes do usu√°rio por quiz (leaderboards/{quiz}/{uid})
        useEffect(() => {
          async function fetchBests(u) {
            if (!u) { setUserBest({}); return; }
            const themes = Object.keys(QUIZZES);
            const snaps = await Promise.all(themes.map((t) => db.ref(`leaderboards/${t}/${u.uid}`).once("value")));
            const map = {};
            themes.forEach((t, i) => { const v = snaps[i].val(); map[t] = v?.points || 0; });
            setUserBest(map);
          }
          fetchBests(user);
        }, [user]);

        // Normaliza o quiz selecionado
        const quiz = normalizeQuizData(selectedQuizKey ? QUIZZES[selectedQuizKey] : null);
        const total = quiz?.questions.length ?? 0;
        const current = quiz?.questions[qid];
        const pct = total ? Math.round(((qid + 1) / total) * 100) : 0;

        async function copyCode(){ try{ await navigator.clipboard.writeText(room || gameCode); setCopied(true); setTimeout(()=>setCopied(false),1500);}catch{} }
        async function signInGoogle(){ try{ await auth.signInWithPopup(googleProvider); } catch{ await auth.signInWithRedirect(googleProvider); } }
        function signOutGoogle(){ auth.signOut(); }

        const roomRefs = (rid) => ({
          players: db.ref(`rooms/${rid}/players`),
          state:   db.ref(`rooms/${rid}/state`),
          answers: (q) => db.ref(`rooms/${rid}/answers/${q}`),
        });

        function listenRoom(rid){
          const { players, state } = roomRefs(rid);
          players.on("value", (snap)=>{
            const val = snap.val() || {};
            const arr = Object.entries(val).map(([id,p])=>({ id, name:p.name, points:p.points|0 }));
            setPlayers(arr);
          });
          state.on("value", (snap)=>{
            const s = snap.val() || { started:false, qid:0 };
            const startedNow = !!s.started;

            // sincroniza tema pra todos
            if (s.theme) setSelectedQuizKey(s.theme);

            const key = s.theme || selectedQuizKey;
            const totalQ = key && QUIZZES[key] ? normalizeQuizData(QUIZZES[key]).questions.length : 0;

            setStarted(startedNow);
            setQid(s.qid|0);
            setPicked(null);

            if (startedNow) {
              setScreen("game");
              savedOnceRef.current = false; // nova partida
            } else {
              const isEnd = (s.end === true) || (typeof s.qid === "number" && totalQ > 0 && s.qid >= totalQ);
              if (isEnd) {
                setScreen("end");
                saveFinalScoreIfNeeded({ theme: key, totalQ, ended: true });
              }
            }
          });
        }

        async function bindPlayerToUidIfNeeded(u) {
          try {
            if (!u || !room) return;
            const { players } = roomRefs(room);
            const snap = await players.once("value");
            const hasUid = snap.child(u.uid).exists();
            const hasFallback = snap.child(playerIdFallback).exists();

            // move pontos do n√≥ tempor√°rio -> uid
            if (!hasUid && hasFallback) {
              const data = snap.child(playerIdFallback).val() || {};
              const next = {
                name: data.name || u.displayName || name || "Jogador",
                points: (data.points | 0),
              };
              await players.child(u.uid).set(next);
              await players.child(playerIdFallback).remove();
              players.child(u.uid).onDisconnect().remove();
            } else if (!hasUid) {
              await players.child(u.uid).set({
                name: u.displayName || name || "Jogador",
                points: 0,
              });
              players.child(u.uid).onDisconnect().remove();
            }
          } catch (e) {
            console.warn("bindPlayerToUidIfNeeded error:", e);
          }
        }

        // Host: cria sala
        function handleCreate(){
          if (!name.trim()) return alert("Digite seu nome");
          const rid = gameCode;
          const { players } = roomRefs(rid);
          players.child(pid).set({ name: user?.displayName || name, points:0 });
          players.child(pid).onDisconnect().remove();
          setRoom(rid); setIsHost(true); setScreen("waiting");
          listenRoom(rid);
        }

        // Jogador: entra em sala
        function handleJoin(){
          if (!name.trim()) return alert("Digite seu nome");
          if (!joinCode.trim()) return alert("Digite o c√≥digo da sala");
          const rid = joinCode.trim().toUpperCase();
          const { players } = roomRefs(rid);
          players.child(pid).set({ name: user?.displayName || name, points:0 });
          players.child(pid).onDisconnect().remove();
          setRoom(rid); setIsHost(false); setScreen("waiting");
          listenRoom(rid);
        }

        // üîÅ Host: inicia (zera pontos de todos ‚Üí pontua√ß√£o POR QUIZ)
        async function startGameHost(){
          if (!selectedQuizKey || !quiz) return;
          const rid = room || gameCode;
          const { state, answers, players } = roomRefs(rid);

          // ZERA a pontua√ß√£o de todos os jogadores da sala (para este novo quiz)
          const snap = await players.once("value");
          const updates = {};
          snap.forEach((child) => { updates[child.key + "/points"] = 0; });
          if (Object.keys(updates).length) await players.update(updates);

          // inicia estado do quiz
          state.set({ started:true, qid:0, correct: quiz.questions[0].c, theme: selectedQuizKey, end:false });
          savedOnceRef.current = false;

          // watchers de respostas da Q0
          answers(0).off();
          answers(0).on("child_added", (snap)=>{
            const { choice } = snap.val()||{}; const pidAns = snap.key;
            if (Number(choice) === Number(quiz.questions[0].c)) players.child(pidAns).child("points").transaction(p => (p||0)+1);
          });

          setScreen("game");
        }

        // Host: pr√≥xima pergunta
        function nextQuestionHost(){
          const rid = room;
          if (!quiz || !rid) return;
          const next = qid + 1;
          const { state, answers, players } = roomRefs(rid);
          if (next >= total){
            state.update({ started:false, qid: next, end:true, theme: selectedQuizKey });
            setScreen("end");
            saveFinalScoreIfNeeded({ theme: selectedQuizKey, totalQ: total, ended: true });
            return;
          }
          state.set({ started:true, qid: next, correct: quiz.questions[next].c, theme: selectedQuizKey, end:false });
          answers(next).off();
          answers(next).on("child_added", (snap)=>{
            const { choice } = snap.val()||{}; const pidAns = snap.key;
            if (Number(choice) === Number(quiz.questions[next].c)) players.child(pidAns).child("points").transaction(p => (p||0)+1);
          });
          setPicked(null);
        }

        // Jogador: responde
        function chooseAnswer(i){
          if (picked !== null) return;
          setPicked(i);
          if (!room || !started) return;
          db.ref(`rooms/${room}/answers/${qid}/${pid}`).set({ choice: i, at: Date.now() });
        }

        // üîê Salva hist√≥rico e atualiza leaderboard
        function saveFinalScoreIfNeeded({ theme, totalQ, ended }) {
          if (!user || !room || !ended || savedOnceRef.current) return;
          savedOnceRef.current = true;

          // tenta primeiro com uid (pid), depois com id tempor√°rio
          const entryByUid = players.find(p => p.id === pid);
          const entryByFallback = players.find(p => p.id === playerIdFallback);
          const myPoints = (entryByUid?.points ?? entryByFallback?.points ?? 0);

          const payload = {
            theme,
            points: myPoints,
            totalQuestions: totalQ,
            room,
            at: Date.now(),
            displayName: user.displayName || name || "Jogador",
            uid: user.uid
          };

          // hist√≥rico do usu√°rio
          db.ref(`users/${user.uid}/results`).push(payload);

          // leaderboard por tema (melhor pontua√ß√£o)
          const lbRef = db.ref(`leaderboards/${theme}/${user.uid}`);
          lbRef.transaction(curr => {
            if (!curr || myPoints > (curr.points || 0)) {
              return {
                points: myPoints,
                displayName: payload.displayName,
                photoURL: user.photoURL || null,
                uid: user.uid,
                updatedAt: Date.now()
              };
            }
            return curr;
          }, (err, committed, snap) => {
            // atualiza cache local do recorde
            const best = snap?.val()?.points ?? myPoints;
            setUserBest(prev => ({ ...prev, [theme]: Math.max(prev[theme] || 0, best) }));
          });
        }

        // Reset visual para voltar ao lobby
        function resetUI(){ setScreen("waiting"); setSelectedQuizKey(null); setQid(0); setPicked(null); }

        // Monta o texto de compartilhamento (din√¢mico)
function buildShareText() {
  const themeName =
    (selectedQuizKey && (QUIZZES[selectedQuizKey]?.name || normalizeQuizData(QUIZZES[selectedQuizKey])?.name)) ||
    quiz?.name || "Quiz";

  const norm = selectedQuizKey ? normalizeQuizData(QUIZZES[selectedQuizKey]) : quiz;
  const totalQ = norm?.questions?.length || 0;

  const sorted = players.slice().sort((a, b) => b.points - a.points);
  const me =
    sorted.find((p) => p.id === (user?.uid || playerIdFallback)) ||
    sorted.find((p) => p.name?.toLowerCase() === (name || "").toLowerCase()) ||
    { name: name || "Jogador", points: 0 };

  const myRank = Math.max(1, sorted.findIndex((p) => p.id === me.id) + 1);
  const percent = totalQ ? Math.round((me.points / totalQ) * 100) : 0;

  // Texto curto, direto e ‚Äúconvidativo‚Äù
  return `Acabei de marcar ${me.points}/${totalQ} (${percent}%) no quiz ‚Äú${themeName}‚Äù no QuizVerso! `
       + `Fiquei em ${myRank}¬∫ üèÜ. Bora me superar?`;
}

// Aciona o compartilhamento com fallback
async function shareResult() {
  const text = buildShareText();
  const url = window.location.origin + window.location.pathname; // link do seu site
  const shareData = { title: "QuizVerso", text, url };

  // 1) Web Share API (mobile/desktop modernos)
  if (navigator.share) {
    try {
      await navigator.share(shareData);
      return;
    } catch (e) {
      // usu√°rio cancelou ou n√£o deu; cai pro fallback
    }
  }

  // 2) Clipboard (desktop)
  try {
    await navigator.clipboard.writeText(`${text}\n${url}`);
    alert("Mensagem copiada! Cole no WhatsApp/Instagram e desafie seus amigos üòâ");
    return;
  } catch (e) {
    // sem permiss√£o de clipboard
  }

  // 3) WhatsApp direto (super-fallback)
  const wa = `https://wa.me/?text=${encodeURIComponent(text + " " + url)}`;
  window.open(wa, "_blank");
}
        
        return (
          <div className="min-h-[100svh] p-4 md:p-6 flex items-center justify-center">
             <BackdropFX />
            <div className="w-full max-w-5xl">
              {/* Header */}
              <div className="flex items-center justify-between mb-4 text-white/80">
                <div className="flex items-center gap-3">
                  <div className="text-xs">Sala: <span className="font-mono">{room || "‚Äî"}</span></div>
                  {user ? (
                    <div className="flex items-center gap-2">
                      {user.photoURL && <img src={user.photoURL} alt="avatar" className="w-6 h-6 rounded-full" />}
                      <span className="text-xs">{user.displayName || "Voc√™"}</span>
                      <button onClick={signOutGoogle} className="text-xs underline hover:opacity-80">Sair</button>
                    </div>
                  ) : (
                    <button onClick={signInGoogle} className="text-xs underline hover:opacity-80">Entrar com Google</button>
                  )}
                </div>
              </div>

              {screen === "lobby" && (
  <div
  className="glass relative w-full max-w-5xl
             h-[calc(100svh-120px)] md:h-[calc(100svh-140px)]
             p-6 sm:p-8 md:p-10 flex flex-col justify-center
             rounded-none md:rounded-2xl"
>
    <div className="shine" />

    {/* LOGO / T√çTULO */}
    <div className="text-center mb-6">
      <div className="inline-flex items-center gap-3">
        <span className="w-10 h-10 grid place-items-center rounded-xl bg-indigo-600 text-white shadow-lg shadow-indigo-800/40 floating">?</span>
        <h1 className="text-4xl md:text-5xl font-extrabold gradient-title tracking-tight">QuizVerso</h1>
      </div>
      <p className="text-white/70 mt-2">Jogo √© jogado. Lambar√≠ √© pescado.</p>
    </div>

    {/* FORM */}
    <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
      <div>
        <div className="text-sm text-white/70 mb-1">Seu nome</div>
        <div className="relative">
          <span className="absolute left-3 top-1/2 -translate-y-1/2 text-white/60">üë§</span>
          <input
            className="input-ghost text-white w-full pl-9 pr-3 py-3 rounded-lg focus:outline-none focus:ring-4 focus:ring-indigo-400/40 placeholder:text-white/50"
            value={name}
            onChange={(e)=>setName(e.target.value)}
            placeholder="Digite seu nome"
          />
        </div>
      </div>
      <div>
        <div className="text-sm text-white/70 mb-1">C√≥digo da sala (se tiver)</div>
        <div className="relative">
          <span className="absolute left-3 top-1/2 -translate-y-1/2 text-white/60">üîë</span>
          <input
            className="input-ghost text-white w-full pl-9 pr-3 py-3 rounded-lg focus:outline-none focus:ring-4 focus:ring-cyan-400/30 placeholder:text-white/50"
            value={joinCode}
            onChange={(e)=>setJoinCode(e.target.value.toUpperCase())}
            placeholder="ABCD1"
          />
        </div>
      </div>
    </div>

    {/* A√á√ïES */}
    <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-6">
      <button
        onClick={handleCreate}
        className="btn-neo w-full px-5 py-3 rounded-full font-semibold text-white inline-flex items-center justify-center gap-2"
      >
        <span>üöÄ</span> Criar Nova Sala
      </button>

      <button
        onClick={handleJoin}
        className="btn-ghost w-full px-5 py-3 rounded-full font-semibold text-white inline-flex items-center justify-center gap-2 hover:bg-white/15"
      >
        <span>üéÆ</span> Entrar na Sala
      </button>
    </div>

    <div className="mt-5 text-center text-xs text-white/70">
      Dica: compartilhe o c√≥digo <span className="font-mono text-white">{gameCode}</span> com os amigos.
    </div>

    <div className="mt-6 grid grid-cols-3 gap-3 text-xs text-white/60">
      <div className="bg-white/5 rounded-lg px-3 py-2 border border-white/10 text-center">üí° Multiplayer em tempo real</div>
      <div className="bg-white/5 rounded-lg px-3 py-2 border border-white/10 text-center">üèÜ Recorde por quiz</div>
      <div className="bg-white/5 rounded-lg px-3 py-2 border border-white/10 text-center">üîí Login Google</div>
    </div>
  </div>
)}


              {screen === "waiting" && (
                <Card>
                  <h2 className="text-2xl font-bold mb-2">Sala de Espera</h2>
                  <p className="text-white/70 mb-4">Compartilhe o c√≥digo e aguarde os jogadores entrarem.</p>
                  <div onClick={copyCode} className="relative border-2 border-dashed border-white/30 rounded-lg p-4 text-center text-xl font-bold select-none cursor-pointer active:scale-[.99]">
                    {room || gameCode}
                    {copied && (<span className="absolute -top-3 right-3 bg-emerald-500 text-white text-xs px-2 py-1 rounded-full shadow">Copiado!</span>)}
                  </div>
                  <p className="text-sm text-white/60 mt-2 text-center">Clique no c√≥digo para copiar</p>

                  <h3 className="text-xl font-semibold mt-6 mb-2">Jogadores na Sala:</h3>
                  <ul className="space-y-2">
                    {players.map((p) => (
                      <li key={p.id} className="flex items-center justify-between bg-white/5 rounded-lg px-4 py-2 border border-white/10">
                        <span className="font-medium">{p.name}</span>
                        <span className="text-sm text-white/70">{p.points} pts</span>
                      </li>
                    ))}
                  </ul>

                  {isHost ? (
                    <div className="mt-6">
                      <h3 className="text-xl font-semibold mb-2">Escolha o Tema do Quiz:</h3>
                      <div className="grid grid-cols-1 gap-2 mb-4">
                        {Object.entries(QUIZZES).map(([key, q]) => {
                          const totalQ = normalizeQuizData(q).questions.length;
                          const best = userBest[key] ?? 0;
                          return (
                            <button
                              key={key}
                              onClick={() => setSelectedQuizKey(key)}
                              className={`text-left px-4 py-3 rounded-xl border transition transform ${
                                selectedQuizKey === key
                                  ? "bg-indigo-600/90 text-white border-indigo-400 shadow-lg scale-[1.01]"
                                  : "bg-white/5 text-white/90 hover:bg-white/10 border-white/10"
                              }`}
                            >
                              <div className="flex items-center justify-between gap-3">
                                <div className="font-semibold">{q.name}</div>
                                <div className="text-xs opacity-75 flex items-center gap-3">
                                  {user ? (
                                    <span className="inline-flex items-center gap-1">
                                      <span className="text-yellow-300">üèÜ</span>
                                      <span className="font-semibold">{best}/{totalQ}</span>
                                      <span>melhor</span>
                                    </span>
                                  ) : null}
                                  <span>{totalQ} quest√µes</span>
                                </div>
                              </div>
                            </button>
                          );
                        })}
                      </div>
                      <Button onClick={startGameHost} disabled={!selectedQuizKey} className="rounded-full disabled:opacity-60 disabled:cursor-not-allowed">Come√ßar o Jogo!</Button>
                    </div>
                  ) : (
                    <p className="mt-6 text-center font-semibold text-white/70">Aguardando o anfitri√£o come√ßar...</p>
                  )}
                </Card>
              )}

              {screen === "game" && (
                <Card>
                  <div className="flex items-center justify-between mb-4">
                    <div>
                      <div className="text-sm font-medium text-white/60">{quiz?.name}</div>
                      <div className="text-lg font-bold">Pergunta <span>{qid + 1}</span>/<span>{total}</span></div>
                    </div>
                  </div>

                  <div className="mb-4 text-xl font-semibold">{current?.q || "Carregando pergunta..."}</div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                    {current?.a?.map((alt, i) => {
                      const isPicked = picked === i;
                      const isCorrect = picked !== null && i === current.c;
                      const base = "px-4 py-3 rounded-xl border text-left transition transform";
                      const state = picked === null ? "bg-white/5 hover:bg-white/10 hover:scale-[1.01] border-white/10"
                        : isCorrect ? "bg-emerald-500/20 border-emerald-400"
                        : isPicked ? "bg-rose-500/20 border-rose-400" : "bg-white/5 opacity-60 border-white/10";
                      const motion = isCorrect ? "pop-anim" : isPicked && !isCorrect ? "shake-anim" : "";
                      return (
                        <button key={i} className={`${base} ${state} ${motion}`} onClick={() => chooseAnswer(i)}>
                          <div className="flex items-center gap-3">
                            <span className={`shrink-0 w-8 h-8 grid place-items-center rounded-full text-sm font-bold ${picked === null ? "bg-white/10 text-white/80" : isCorrect ? "bg-emerald-500 text-white" : isPicked ? "bg-rose-500 text-white" : "bg-white/10 text-white/60"}`}>
                              {["A","B","C","D","E","F"][i]}
                            </span>
                            <span className="flex-1">{alt}</span>
                            {picked !== null && (<span className="text-lg">{isCorrect ? "‚úÖ" : isPicked ? "‚ùå" : ""}</span>)}
                          </div>
                        </button>
                      );
                    })}
                  </div>

                  <div className="mt-6">
                    <h4 className="text-lg font-semibold mb-2">Ranking (ao vivo)</h4>
                    <ul className="space-y-2">
                      {players.slice().sort((a,b)=> b.points - a.points).map((p, i) => (
                        <li key={p.id + i} className="flex items-center justify-between bg-white/5 rounded-lg px-4 py-2 border border-white/10">
                          <div className="flex items-center gap-3">
                            <span className="w-6 text-center font-bold">{i+1}</span>
                            <span className="font-medium">{p.name}</span>
                          </div>
                          <span className="text-sm text-white/70">{p.points} pts</span>
                        </li>
                      ))}
                    </ul>
                  </div>

                  <div className="mt-6">
                    <div className="relative w-full h-2 bg-white/10 rounded-full overflow-hidden">
                      <div className="h-2 bg-indigo-400 rounded-full transition-all" style={{ width: `${pct}%` }} />
                    </div>
                    <div className="text-xs text-white/60 mt-1">Progresso: {pct}%</div>
                  </div>

                  <div className="mt-6 text-center">
                    {isHost ? (
                      <Button onClick={nextQuestionHost} disabled={picked === null} className="rounded-full disabled:opacity-60 disabled:cursor-not-allowed">Pr√≥xima Pergunta (Host)</Button>
                    ) : (
                      <div className="text-sm text-white/60">Aguardando o anfitri√£o avan√ßar‚Ä¶</div>
                    )}
                  </div>
                </Card>
              )}

              {screen === "end" && (
                <>
                  <Confetti count={100} />
                  <Card className="text-center relative z-10">
                    <h1 className="text-4xl font-extrabold mb-2">Fim de Jogo!</h1>
                    <h2 className="text-2xl font-semibold text-indigo-200 mb-6">
                      O grande vencedor √©... <span className="text-3xl text-white">{players.slice().sort((a,b)=>b.points-a.points)[0]?.name || "‚Äî"}</span>!
                    </h2>
                    <h3 className="text-xl font-semibold mt-4 mb-2">Placar Final:</h3>
                    <ul className="space-y-2 max-w-md mx-auto">
                      {players.slice().sort((a,b)=> b.points - a.points).map((p, i) => (
                        <li key={p.id + i} className="flex items-center justify-between bg-white/5 rounded-lg px-4 py-2 border border-white/10">
                          <span className="font-medium">{i + 1}. {p.name}</span>
                          <span className="text-sm text-white/70">{p.points} pts</span>
                        </li>
                      ))}
                    </ul>
                   <div className="mt-6 grid gap-3 max-w-sm mx-auto">
  {/* Bot√£o chamativo de compartilhar */}
  <button
    onClick={shareResult}
    className="w-full rounded-full px-5 py-3 font-semibold text-white btn-neo
               shadow-lg shadow-indigo-900/40 hover:brightness-105 active:scale-[.99]
               inline-flex items-center justify-center gap-2"
  >
    <span>üì£</span> Compartilhar meu resultado
  </button>

  {/* Voltar / Jogar de novo */}
  <Button onClick={resetUI} className="rounded-full">Menu Principal</Button>

  {/* Mini dica opcional */}
  <div className="text-xs text-white/60 text-center">
    Dica: compartilhar aumenta a disputa e traz novos jogadores para a sala!
  </div>
</div>

                  </Card>
                </>
              )}
            </div>
          </div>
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>





